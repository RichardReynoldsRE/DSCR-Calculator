<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commercial Property DSCR Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #718096;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .section-header {
            color: #2d3748;
            font-size: 18px;
            font-weight: 600;
            margin-top: 25px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }

        .section-header:first-of-type {
            margin-top: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .help-text {
            font-size: 12px;
            color: #718096;
            font-weight: 400;
            margin-top: 4px;
        }

        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .calculated-field {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calculated-label {
            color: #4a5568;
            font-weight: 600;
        }

        .calculated-value {
            color: #2d3748;
            font-size: 18px;
            font-weight: 700;
        }

        .info-box {
            background: #ebf8ff;
            border-left: 4px solid #4299e1;
            padding: 12px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 13px;
            color: #2c5282;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .results {
            margin-top: 30px;
            padding: 25px;
            background: #f7fafc;
            border-radius: 12px;
            display: none;
        }

        .results.show {
            display: block;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-label {
            color: #4a5568;
            font-weight: 500;
        }

        .result-value {
            color: #2d3748;
            font-weight: 600;
        }

        .dscr-value {
            font-size: 32px;
            text-align: center;
            margin: 20px 0;
            color: #2d3748;
        }

        .dscr-status {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 15px;
        }

        .dscr-status.good {
            background: #c6f6d5;
            color: #22543d;
        }

        .dscr-status.warning {
            background: #feebc8;
            color: #7c2d12;
        }

        .dscr-status.poor {
            background: #fed7d7;
            color: #742a2a;
        }

        .note {
            background: #edf2f7;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 13px;
            color: #4a5568;
            line-height: 1.6;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 10px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #667eea;
            color: white;
        }

        .load-section {
            margin-top: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            text-align: center;
        }

        .load-section input[type="file"] {
            display: none;
        }

        .load-label {
            display: inline-block;
            padding: 10px 20px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .load-label:hover {
            background: #667eea;
            color: white;
        }

        .hidden {
            display: none;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                max-width: 100%;
                padding: 20px;
            }

            form, .note, .action-buttons, .load-section {
                display: none !important;
            }

            .results {
                display: block !important;
                page-break-inside: avoid;
            }

            .section-header {
                page-break-after: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>DSCR Calculator</h1>
        <p class="subtitle">Debt Service Coverage Ratio for 5-8 unit properties</p>

        <div class="load-section">
            <p style="margin-bottom: 10px; color: #4a5568; font-weight: 600;">Load Previous Calculation</p>
            <input type="file" id="load-file" accept=".json">
            <label for="load-file" class="load-label">Choose File to Load</label>
        </div>

        <form id="dscr-form">
            <div class="section-header">Property Information</div>
            
            <div class="form-group">
                <label for="property-address">
                    Property Address
                    <div class="help-text">Street address, city, state, ZIP</div>
                </label>
                <input type="text" id="property-address" placeholder="e.g., 123 Main St, City, State 12345">
            </div>

            <div class="section-header">Property Overview</div>
            
            <div class="form-group">
                <label for="total-units">
                    Total Number of Units *
                    <div class="help-text">Total units in the property (5-8)</div>
                </label>
                <input type="number" id="total-units" required min="1" max="100" step="1" placeholder="e.g., 8">
            </div>

            <div class="form-group">
                <label for="vacant-units">
                    Number of Vacant Units *
                    <div class="help-text">How many units are currently empty</div>
                </label>
                <input type="number" id="vacant-units" required min="0" step="1" value="0" placeholder="e.g., 0">
            </div>

            <div class="section-header">Property Income</div>
            
            <div class="form-group">
                <label for="occupied-income">
                    Annual Income from Occupied Units *
                    <div class="help-text">Total rent collected per year from rented units</div>
                </label>
                <input type="number" id="occupied-income" required min="0" step="0.01" placeholder="e.g., 96000">
            </div>

            <div class="form-group hidden" id="vacant-income-group">
                <label for="vacant-income">
                    Potential Annual Income from Vacant Units *
                    <div class="help-text">What vacant units could generate if rented at market rate</div>
                </label>
                <input type="number" id="vacant-income" min="0" step="0.01" value="0" placeholder="e.g., 24000">
                <div class="info-box">
                    Lenders typically apply a 75% factor to vacant unit income to account for risk.
                </div>
            </div>

            <div class="section-header">Property Expenses</div>

            <div class="form-group">
                <label for="property-tax">
                    Annual Property Taxes *
                    <div class="help-text">Yearly property tax bill</div>
                </label>
                <input type="number" id="property-tax" required min="0" step="0.01" placeholder="e.g., 8000">
            </div>

            <div class="form-group">
                <label for="insurance">
                    Annual Insurance *
                    <div class="help-text">Property and liability insurance costs per year</div>
                </label>
                <input type="number" id="insurance" required min="0" step="0.01" placeholder="e.g., 3000">
            </div>

            <div class="form-group">
                <label for="utilities">
                    Annual Utilities
                    <div class="help-text">Water, electric, gas paid by owner (if any)</div>
                </label>
                <input type="number" id="utilities" min="0" step="0.01" value="0" placeholder="e.g., 2400">
            </div>

            <div class="form-group">
                <label for="maintenance">
                    Annual Maintenance & Repairs
                    <div class="help-text">Routine maintenance, repairs, landscaping, etc.</div>
                </label>
                <input type="number" id="maintenance" min="0" step="0.01" value="0" placeholder="e.g., 5000">
            </div>

            <div class="form-group">
                <label for="other-expenses">
                    Other Annual Operating Expenses
                    <div class="help-text">HOA fees, pest control, advertising, etc.</div>
                </label>
                <input type="number" id="other-expenses" min="0" step="0.01" value="0" placeholder="e.g., 1500">
            </div>

            <div class="calculated-field">
                <span class="calculated-label">Effective Gross Income:</span>
                <span class="calculated-value" id="egi-display">$0</span>
            </div>

            <div class="calculated-field">
                <span class="calculated-label">Net Operating Income (NOI):</span>
                <span class="calculated-value" id="noi-display">$0</span>
            </div>

            <div class="section-header">Adjustments</div>

            <div class="form-group">
                <label>Does the appraisal report include a management fee? *</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="mgmt-yes" name="management" value="yes" required>
                        <label for="mgmt-yes" style="margin: 0;">Yes</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="mgmt-no" name="management" value="no" checked>
                        <label for="mgmt-no" style="margin: 0;">No</label>
                    </div>
                </div>
            </div>

            <div class="form-group hidden" id="mgmt-fee-group">
                <label for="mgmt-fee">
                    Annual Management Fee
                    <div class="help-text">Management fee amount from appraisal report</div>
                </label>
                <input type="number" id="mgmt-fee" min="0" step="0.01" placeholder="e.g., 6000">
            </div>

            <div class="section-header">Loan Details</div>

            <div class="form-group">
                <label for="purchase-price">
                    Purchase Price *
                    <div class="help-text">Total purchase price of the property</div>
                </label>
                <input type="number" id="purchase-price" required min="0" step="0.01" placeholder="e.g., 1000000">
            </div>

            <div class="form-group">
                <label for="down-payment">
                    Down Payment (%) *
                    <div class="help-text">Percentage of purchase price paid as down payment</div>
                </label>
                <input type="number" id="down-payment" required min="0" max="100" step="0.1" value="20" placeholder="e.g., 20">
            </div>

            <div class="calculated-field">
                <span class="calculated-label">Loan Amount:</span>
                <span class="calculated-value" id="loan-amount-display">$0</span>
            </div>

            <div class="form-group">
                <label for="interest-rate">
                    Interest Rate (%) *
                    <div class="help-text">Annual interest rate for the loan</div>
                </label>
                <input type="number" id="interest-rate" required min="0" max="100" step="0.01" placeholder="e.g., 7.5">
            </div>

            <div class="form-group">
                <label>Payment Type *</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="payment-amortizing" name="payment-type" value="amortizing" required checked>
                        <label for="payment-amortizing" style="margin: 0;">Amortizing (Principal + Interest)</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="payment-interest" name="payment-type" value="interest">
                        <label for="payment-interest" style="margin: 0;">Interest Only</label>
                    </div>
                </div>
            </div>

            <div class="form-group" id="loan-term-group">
                <label for="loan-term">
                    Loan Term (Years) *
                    <div class="help-text">Number of years to repay the loan</div>
                </label>
                <input type="number" id="loan-term" required min="1" max="50" step="1" placeholder="e.g., 30">
            </div>

            <button type="submit">Calculate DSCR</button>
        </form>

        <div class="results" id="results">
            <div class="result-row" id="address-result" style="display: none;">
                <span class="result-label">Property Address:</span>
                <span class="result-value" id="result-address">-</span>
            </div>
            <div class="result-row">
                <span class="result-label">Purchase Price:</span>
                <span class="result-value" id="result-purchase-price">$0</span>
            </div>
            <div class="result-row">
                <span class="result-label">Down Payment:</span>
                <span class="result-value" id="result-down-payment">$0</span>
            </div>
            <div class="result-row">
                <span class="result-label">Loan Amount:</span>
                <span class="result-value" id="result-loan-amount">$0</span>
            </div>
            <div class="result-row">
                <span class="result-label">Occupied Unit Income:</span>
                <span class="result-value" id="result-occupied">$0</span>
            </div>
            <div class="result-row">
                <span class="result-label">Vacant Unit Income (75%):</span>
                <span class="result-value" id="result-vacant">$0</span>
            </div>
            <div class="result-row">
                <span class="result-label">Effective Gross Income:</span>
                <span class="result-value" id="result-egi">$0</span>
            </div>
            <div class="result-row">
                <span class="result-label">Total Operating Expenses:</span>
                <span class="result-value" id="result-expenses">$0</span>
            </div>
            <div class="result-row">
                <span class="result-label">Net Operating Income:</span>
                <span class="result-value" id="result-noi">$0</span>
            </div>
            <div class="result-row">
                <span class="result-label">Additional Adjustment:</span>
                <span class="result-value" id="result-adjustment">-</span>
            </div>
            <div class="result-row">
                <span class="result-label">Qualifying Income:</span>
                <span class="result-value" id="result-income">$0</span>
            </div>
            <div class="result-row">
                <span class="result-label">Payment Type:</span>
                <span class="result-value" id="result-payment-type">-</span>
            </div>
            <div class="result-row">
                <span class="result-label">Annual Debt Service:</span>
                <span class="result-value" id="result-debt">$0</span>
            </div>
            
            <div class="dscr-value" id="dscr-value">0.00</div>
            <div class="dscr-status" id="dscr-status"></div>

            <div class="action-buttons">
                <button type="button" class="action-btn" onclick="emailResults()">📧 Email Results</button>
                <button type="button" class="action-btn" onclick="printResults()">🖨️ Print Results</button>
                <button type="button" class="action-btn" onclick="saveResults()">💾 Save Calculation</button>
                <button type="button" class="action-btn" onclick="resetForm()">🔄 New Calculation</button>
            </div>
        </div>

        <div class="note">
            <strong>Understanding DSCR:</strong><br>
            DSCR (Debt Service Coverage Ratio) measures if your property generates enough income to cover loan payments. Most lenders require a minimum DSCR of 1.20-1.25.<br><br>
            <strong>How loan amount is calculated:</strong><br>
            • Loan Amount = Purchase Price × (1 - Down Payment %)<br>
            • Typical down payment: 20-25% for commercial properties<br><br>
            <strong>How qualifying income is calculated:</strong><br>
            • Occupied units: 100% of actual rental income<br>
            • Vacant units: 75% of potential rental income<br>
            • With management fee: Subtract management fee from NOI<br>
            • No management fee: Multiply NOI by 92%<br><br>
            <strong>Payment Types:</strong><br>
            • Amortizing: Regular principal + interest payments over the loan term<br>
            • Interest Only: Pay only interest (no principal reduction)<br><br>
            <strong>Formula:</strong> DSCR = Qualifying Income ÷ Annual Debt Service
        </div>
    </div>

    <script>
        // Get all DOM elements
        const form = document.getElementById('dscr-form');
        const results = document.getElementById('results');
        
        // Form fields
        const propertyAddressInput = document.getElementById('property-address');
        const totalUnitsInput = document.getElementById('total-units');
        const vacantUnitsInput = document.getElementById('vacant-units');
        const occupiedIncomeInput = document.getElementById('occupied-income');
        const vacantIncomeInput = document.getElementById('vacant-income');
        const propertyTaxInput = document.getElementById('property-tax');
        const insuranceInput = document.getElementById('insurance');
        const utilitiesInput = document.getElementById('utilities');
        const maintenanceInput = document.getElementById('maintenance');
        const otherExpensesInput = document.getElementById('other-expenses');
        const purchasePriceInput = document.getElementById('purchase-price');
        const downPaymentInput = document.getElementById('down-payment');
        const interestRateInput = document.getElementById('interest-rate');
        const loanTermInput = document.getElementById('loan-term');
        
        // Radio buttons
        const mgmtYes = document.getElementById('mgmt-yes');
        const mgmtNo = document.getElementById('mgmt-no');
        const mgmtFeeInput = document.getElementById('mgmt-fee');
        const mgmtFeeGroup = document.getElementById('mgmt-fee-group');
        const paymentAmortizing = document.getElementById('payment-amortizing');
        const paymentInterest = document.getElementById('payment-interest');
        const loanTermGroup = document.getElementById('loan-term-group');
        
        // Display elements
        const vacantIncomeGroup = document.getElementById('vacant-income-group');
        const egiDisplay = document.getElementById('egi-display');
        const noiDisplay = document.getElementById('noi-display');
        const loanAmountDisplay = document.getElementById('loan-amount-display');

        // Show/hide vacant income field based on vacant units
        vacantUnitsInput.addEventListener('input', function() {
            const vacantUnits = parseInt(this.value) || 0;
            if (vacantUnits > 0) {
                vacantIncomeGroup.classList.remove('hidden');
                vacantIncomeInput.required = true;
            } else {
                vacantIncomeGroup.classList.add('hidden');
                vacantIncomeInput.required = false;
                vacantIncomeInput.value = 0;
            }
            updateRealTimeCalculations();
        });

        // Show/hide management fee input
        mgmtYes.addEventListener('change', function() {
            mgmtFeeGroup.classList.remove('hidden');
        });

        mgmtNo.addEventListener('change', function() {
            mgmtFeeGroup.classList.add('hidden');
            mgmtFeeInput.value = '';
        });

        // Show/hide loan term based on payment type
        paymentAmortizing.addEventListener('change', function() {
            loanTermGroup.classList.remove('hidden');
            loanTermInput.required = true;
        });

        paymentInterest.addEventListener('change', function() {
            loanTermGroup.classList.add('hidden');
            loanTermInput.required = false;
        });

        // Real-time calculation updates
        const incomeExpenseInputs = [
            occupiedIncomeInput, vacantIncomeInput, propertyTaxInput, 
            insuranceInput, utilitiesInput, maintenanceInput, otherExpensesInput
        ];

        incomeExpenseInputs.forEach(input => {
            input.addEventListener('input', updateRealTimeCalculations);
        });

        purchasePriceInput.addEventListener('input', updateLoanAmountDisplay);
        downPaymentInput.addEventListener('input', updateLoanAmountDisplay);

        function updateLoanAmountDisplay() {
            const purchasePrice = parseFloat(purchasePriceInput.value) || 0;
            const downPaymentPct = parseFloat(downPaymentInput.value) || 0;
            const calculatedLoan = purchasePrice * (1 - downPaymentPct / 100);
            loanAmountDisplay.textContent = formatCurrency(calculatedLoan);
        }

        function updateRealTimeCalculations() {
            const occupiedIncome = parseFloat(occupiedIncomeInput.value) || 0;
            const vacantIncome = parseFloat(vacantIncomeInput.value) || 0;
            const vacantUnits = parseInt(vacantUnitsInput.value) || 0;
            
            // Apply 75% to vacant unit income
            const adjustedVacantIncome = vacantUnits > 0 ? vacantIncome * 0.75 : 0;
            const egi = occupiedIncome + adjustedVacantIncome;
            
            const propertyTax = parseFloat(propertyTaxInput.value) || 0;
            const insurance = parseFloat(insuranceInput.value) || 0;
            const utilities = parseFloat(utilitiesInput.value) || 0;
            const maintenance = parseFloat(maintenanceInput.value) || 0;
            const otherExpenses = parseFloat(otherExpensesInput.value) || 0;

            const totalExpenses = propertyTax + insurance + utilities + maintenance + otherExpenses;
            const noi = egi - totalExpenses;

            egiDisplay.textContent = formatCurrency(egi);
            noiDisplay.textContent = formatCurrency(noi);
        }

        function formatCurrency(value) {
            return '$' + value.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            calculateDSCR();
        });

        function calculateDSCR() {
            // Get property info
            const propertyAddress = propertyAddressInput.value;
            const totalUnits = totalUnitsInput.value;
            const vacantUnits = parseInt(vacantUnitsInput.value) || 0;
            
            // Calculate income
            const occupiedIncome = parseFloat(occupiedIncomeInput.value);
            const vacantIncome = parseFloat(vacantIncomeInput.value) || 0;
            const adjustedVacantIncome = vacantUnits > 0 ? vacantIncome * 0.75 : 0;
            const egi = occupiedIncome + adjustedVacantIncome;

            // Calculate expenses
            const propertyTax = parseFloat(propertyTaxInput.value);
            const insurance = parseFloat(insuranceInput.value);
            const utilities = parseFloat(utilitiesInput.value) || 0;
            const maintenance = parseFloat(maintenanceInput.value) || 0;
            const otherExpenses = parseFloat(otherExpensesInput.value) || 0;
            const totalExpenses = propertyTax + insurance + utilities + maintenance + otherExpenses;
            const noi = egi - totalExpenses;

            // Get adjustments
            const hasMgmtFee = document.querySelector('input[name="management"]:checked').value === 'yes';
            const mgmtFee = hasMgmtFee ? parseFloat(mgmtFeeInput.value) || 0 : 0;
            
            // Calculate loan details
            const purchasePrice = parseFloat(purchasePriceInput.value);
            const downPaymentPct = parseFloat(downPaymentInput.value);
            const downPaymentAmount = purchasePrice * (downPaymentPct / 100);
            const finalLoanAmount = purchasePrice - downPaymentAmount;
            
            const interestRate = parseFloat(interestRateInput.value) / 100;
            const paymentType = document.querySelector('input[name="payment-type"]:checked').value;
            const loanTerm = paymentType === 'amortizing' ? parseInt(loanTermInput.value) : 0;

            // Calculate qualifying income
            let qualifyingIncome;
            let adjustmentText;

            if (hasMgmtFee && mgmtFee > 0) {
                qualifyingIncome = noi - mgmtFee;
                adjustmentText = `Mgmt Fee: -${formatCurrency(mgmtFee)}`;
            } else if (vacantUnits === 0) {
                qualifyingIncome = noi * 0.92;
                adjustmentText = 'NOI × 92% (No Mgmt Fee)';
            } else {
                qualifyingIncome = noi;
                adjustmentText = 'None (Vacancy Already Adjusted)';
            }

            // Calculate annual debt service
            let annualDebtService;
            
            if (paymentType === 'interest') {
                annualDebtService = finalLoanAmount * interestRate;
            } else {
                const monthlyRate = interestRate / 12;
                const numPayments = loanTerm * 12;
                const monthlyPayment = finalLoanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
                annualDebtService = monthlyPayment * 12;
            }

            // Calculate DSCR
            const dscr = qualifyingIncome / annualDebtService;

            // Display results
            if (propertyAddress) {
                document.getElementById('address-result').style.display = 'flex';
                document.getElementById('result-address').textContent = propertyAddress;
            } else {
                document.getElementById('address-result').style.display = 'none';
            }
            
            document.getElementById('result-purchase-price').textContent = formatCurrency(purchasePrice);
            document.getElementById('result-down-payment').textContent = `${formatCurrency(downPaymentAmount)} (${downPaymentPct}%)`;
            document.getElementById('result-loan-amount').textContent = formatCurrency(finalLoanAmount);
            document.getElementById('result-occupied').textContent = formatCurrency(occupiedIncome);
            document.getElementById('result-vacant').textContent = formatCurrency(adjustedVacantIncome);
            document.getElementById('result-egi').textContent = formatCurrency(egi);
            document.getElementById('result-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('result-noi').textContent = formatCurrency(noi);
            document.getElementById('result-adjustment').textContent = adjustmentText;
            document.getElementById('result-income').textContent = formatCurrency(qualifyingIncome);
            document.getElementById('result-payment-type').textContent = paymentType === 'interest' ? 'Interest Only' : 'Amortizing';
            document.getElementById('result-debt').textContent = formatCurrency(annualDebtService);
            document.getElementById('dscr-value').textContent = dscr.toFixed(2);

            // DSCR status
            const statusEl = document.getElementById('dscr-status');
            if (dscr >= 1.25) {
                statusEl.textContent = 'Excellent - Strong Likelihood of Approval';
                statusEl.className = 'dscr-status good';
            } else if (dscr >= 1.20) {
                statusEl.textContent = 'Good - Meets Typical Minimum Requirements';
                statusEl.className = 'dscr-status good';
            } else if (dscr >= 1.00) {
                statusEl.textContent = 'Fair - May Require Additional Review';
                statusEl.className = 'dscr-status warning';
            } else {
                statusEl.textContent = 'Below Minimum - May Not Qualify';
                statusEl.className = 'dscr-status poor';
            }

            results.classList.add('show');
            results.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Email Results
        function emailResults() {
            const propertyAddress = propertyAddressInput.value || 'Not specified';
            const totalUnits = totalUnitsInput.value;
            const vacantUnits = vacantUnitsInput.value;
            
            const purchasePrice = parseFloat(purchasePriceInput.value);
            const downPaymentPct = parseFloat(downPaymentInput.value);
            const downPaymentAmount = purchasePrice * (downPaymentPct / 100);
            const finalLoanAmount = purchasePrice - downPaymentAmount;
            const interestRate = interestRateInput.value;
            const paymentType = document.querySelector('input[name="payment-type"]:checked').value;
            const loanTerm = loanTermInput.value;

            const occupiedIncome = document.getElementById('result-occupied').textContent;
            const vacantIncome = document.getElementById('result-vacant').textContent;
            const egi = document.getElementById('result-egi').textContent;
            const expenses = document.getElementById('result-expenses').textContent;
            const noi = document.getElementById('result-noi').textContent;
            const adjustment = document.getElementById('result-adjustment').textContent;
            const qualifyingIncome = document.getElementById('result-income').textContent;
            const paymentTypeDisplay = document.getElementById('result-payment-type').textContent;
            const annualDebt = document.getElementById('result-debt').textContent;
            const dscr = document.getElementById('dscr-value').textContent;
            const status = document.getElementById('dscr-status').textContent;

            const addressLine = propertyAddress !== 'Not specified' ? `Property Address: ${propertyAddress}\n` : '';

            const subject = encodeURIComponent('DSCR Calculation Results' + (propertyAddress !== 'Not specified' ? ` - ${propertyAddress}` : ''));
            const body = encodeURIComponent(
                `DEBT SERVICE COVERAGE RATIO (DSCR) CALCULATION\n` +
                `Generated: ${new Date().toLocaleString()}\n\n` +
                `═══════════════════════════════════════════════\n` +
                `PROPERTY INFORMATION\n` +
                `═══════════════════════════════════════════════\n` +
                `${addressLine}` +
                `Total Units: ${totalUnits}\n` +
                `Vacant Units: ${vacantUnits}\n\n` +
                `═══════════════════════════════════════════════\n` +
                `FINANCIAL OVERVIEW\n` +
                `═══════════════════════════════════════════════\n` +
                `Purchase Price: ${formatCurrency(purchasePrice)}\n` +
                `Down Payment: ${formatCurrency(downPaymentAmount)} (${downPaymentPct}%)\n` +
                `Loan Amount: ${formatCurrency(finalLoanAmount)}\n` +
                `Interest Rate: ${interestRate}%\n` +
                `Payment Type: ${paymentTypeDisplay}\n` +
                (paymentTypeDisplay === 'Amortizing' ? `Loan Term: ${loanTerm} years\n` : '') +
                `\n═══════════════════════════════════════════════\n` +
                `INCOME ANALYSIS\n` +
                `═══════════════════════════════════════════════\n` +
                `Occupied Unit Income: ${occupiedIncome}\n` +
                `Vacant Unit Income (75%): ${vacantIncome}\n` +
                `Effective Gross Income: ${egi}\n\n` +
                `═══════════════════════════════════════════════\n` +
                `EXPENSES\n` +
                `═══════════════════════════════════════════════\n` +
                `Property Taxes: ${formatCurrency(parseFloat(propertyTaxInput.value))}\n` +
                `Insurance: ${formatCurrency(parseFloat(insuranceInput.value))}\n` +
                `Utilities: ${formatCurrency(parseFloat(utilitiesInput.value) || 0)}\n` +
                `Maintenance: ${formatCurrency(parseFloat(maintenanceInput.value) || 0)}\n` +
                `Other Expenses: ${formatCurrency(parseFloat(otherExpensesInput.value) || 0)}\n` +
                `Total Operating Expenses: ${expenses}\n\n` +
                `═══════════════════════════════════════════════\n` +
                `DSCR CALCULATION\n` +
                `═══════════════════════════════════════════════\n` +
                `Net Operating Income (NOI): ${noi}\n` +
                `Additional Adjustment: ${adjustment}\n` +
                `Qualifying Income: ${qualifyingIncome}\n` +
                `Annual Debt Service: ${annualDebt}\n\n` +
                `DSCR: ${dscr}\n` +
                `Status: ${status}\n\n` +
                `═══════════════════════════════════════════════\n` +
                `NOTES\n` +
                `═══════════════════════════════════════════════\n` +
                `Most lenders require a minimum DSCR of 1.20-1.25\n` +
                `Formula: DSCR = Qualifying Income ÷ Annual Debt Service\n\n` +
                `This calculation is for informational purposes only and does not constitute a loan commitment.`
            );

            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        // Print Results
        function printResults() {
            window.print();
        }

        // Save Results
        function saveResults() {
            const data = {
                timestamp: new Date().toISOString(),
                inputs: {
                    propertyAddress: propertyAddressInput.value,
                    totalUnits: totalUnitsInput.value,
                    vacantUnits: vacantUnitsInput.value,
                    occupiedIncome: occupiedIncomeInput.value,
                    vacantIncome: vacantIncomeInput.value,
                    propertyTax: propertyTaxInput.value,
                    insurance: insuranceInput.value,
                    utilities: utilitiesInput.value,
                    maintenance: maintenanceInput.value,
                    otherExpenses: otherExpensesInput.value,
                    hasMgmtFee: document.querySelector('input[name="management"]:checked')?.value,
                    mgmtFee: mgmtFeeInput.value,
                    purchasePrice: purchasePriceInput.value,
                    downPayment: downPaymentInput.value,
                    interestRate: interestRateInput.value,
                    paymentType: document.querySelector('input[name="payment-type"]:checked')?.value,
                    loanTerm: loanTermInput.value
                },
                results: {
                    propertyAddress: propertyAddressInput.value || 'Not specified',
                    purchasePrice: document.getElementById('result-purchase-price').textContent,
                    downPayment: document.getElementById('result-down-payment').textContent,
                    loanAmount: document.getElementById('result-loan-amount').textContent,
                    occupiedIncome: document.getElementById('result-occupied').textContent,
                    vacantIncome: document.getElementById('result-vacant').textContent,
                    egi: document.getElementById('result-egi').textContent,
                    expenses: document.getElementById('result-expenses').textContent,
                    noi: document.getElementById('result-noi').textContent,
                    adjustment: document.getElementById('result-adjustment').textContent,
                    qualifyingIncome: document.getElementById('result-income').textContent,
                    paymentType: document.getElementById('result-payment-type').textContent,
                    annualDebt: document.getElementById('result-debt').textContent,
                    dscr: document.getElementById('dscr-value').textContent,
                    status: document.getElementById('dscr-status').textContent
                }
            };

            // Create filename with address
            const address = propertyAddressInput.value || 'Property';
            const cleanAddress = address
                .replace(/,/g, '') // Remove commas
                .replace(/[^a-zA-Z0-9\s-]/g, '') // Remove other special characters
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .replace(/-+/g, '-') // Replace multiple hyphens with single hyphen
                .replace(/^-|-$/g, '') // Remove leading/trailing hyphens
                .substring(0, 50); // Limit length
            const date = new Date().toISOString().split('T')[0];
            const filename = `${cleanAddress}-${date}-DSCR-Calculation.json`;

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Reset Form
        function resetForm() {
            form.reset();
            results.classList.remove('show');
            vacantIncomeGroup.classList.add('hidden');
            mgmtFeeGroup.classList.add('hidden');
            loanTermGroup.classList.remove('hidden');
            egiDisplay.textContent = '$0';
            noiDisplay.textContent = '$0';
            loanAmountDisplay.textContent = '$0';
        }

        // Load File
        document.getElementById('load-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    // Populate all form fields
                    propertyAddressInput.value = data.inputs.propertyAddress || '';
                    totalUnitsInput.value = data.inputs.totalUnits || '';
                    vacantUnitsInput.value = data.inputs.vacantUnits || '0';
                    occupiedIncomeInput.value = data.inputs.occupiedIncome || '';
                    vacantIncomeInput.value = data.inputs.vacantIncome || '0';
                    propertyTaxInput.value = data.inputs.propertyTax || '';
                    insuranceInput.value = data.inputs.insurance || '';
                    utilitiesInput.value = data.inputs.utilities || '0';
                    maintenanceInput.value = data.inputs.maintenance || '0';
                    otherExpensesInput.value = data.inputs.otherExpenses || '0';
                    
                    // Handle both old and new format
                    if (data.inputs.purchasePrice) {
                        purchasePriceInput.value = data.inputs.purchasePrice || '';
                        downPaymentInput.value = data.inputs.downPayment || '20';
                    } else if (data.inputs.loanAmount) {
                        const oldLoanAmount = parseFloat(data.inputs.loanAmount);
                        const estimatedPurchasePrice = oldLoanAmount / 0.8;
                        purchasePriceInput.value = estimatedPurchasePrice.toFixed(2);
                        downPaymentInput.value = '20';
                    }
                    
                    interestRateInput.value = data.inputs.interestRate || '';
                    loanTermInput.value = data.inputs.loanTerm || '';

                    // Set payment type
                    if (data.inputs.paymentType === 'interest') {
                        paymentInterest.checked = true;
                        loanTermGroup.classList.add('hidden');
                        loanTermInput.required = false;
                    } else {
                        paymentAmortizing.checked = true;
                        loanTermGroup.classList.remove('hidden');
                        loanTermInput.required = true;
                    }

                    // Set management fee
                    if (data.inputs.hasMgmtFee === 'yes') {
                        mgmtYes.checked = true;
                        mgmtFeeGroup.classList.remove('hidden');
                        mgmtFeeInput.value = data.inputs.mgmtFee || '';
                    } else {
                        mgmtNo.checked = true;
                        mgmtFeeGroup.classList.add('hidden');
                    }

                    // Trigger updates
                    vacantUnitsInput.dispatchEvent(new Event('input'));
                    updateLoanAmountDisplay();
                    updateRealTimeCalculations();

                    form.scrollIntoView({ behavior: 'smooth' });
                    alert('Calculation loaded successfully! Review the values and click "Calculate DSCR" to see results.');
                    
                } catch (error) {
                    alert('Error loading file. Please make sure it is a valid DSCR calculation file.');
                    console.error('Load error:', error);
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });
    </script>
</body>
</html>
