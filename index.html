<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSCR Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #fafbfc;
            min-height: 100vh;
            padding: 20px;
            color: #0f172a;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1280px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 48px;
            padding: 60px 20px 40px;
        }
        
        h1 {
            color: #0f172a;
            margin-bottom: 12px;
            font-size: 3em;
            font-weight: 700;
            letter-spacing: -1.5px;
        }
        
        .subtitle {
            color: #64748b;
            font-size: 1.125rem;
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .section {
            background: white;
            padding: 32px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
            transition: box-shadow 0.2s;
        }
        
        .section:hover {
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.04);
        }
        
        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 500;
            color: #0f172a;
            margin-bottom: 8px;
            font-size: 0.875rem;
        }
        
        .help-text {
            font-size: 0.8125rem;
            color: #64748b;
            margin-top: 6px;
            line-height: 1.5;
        }
        
        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 0.9375rem;
            transition: all 0.15s ease;
            background: white;
            color: #0f172a;
        }
        
        input[type="number"]:focus, input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.08);
        }
        
        input[type="number"]:hover, input[type="text"]:hover, select:hover {
            border-color: #94a3b8;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .radio-option label {
            margin-bottom: 0;
            font-weight: 400;
            cursor: pointer;
        }
        
        input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #2563eb;
        }
        
        .calculated-field {
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e2e8f0;
        }
        
        .calculated-label {
            color: #64748b;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .calculated-value {
            color: #0f172a;
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .info-box {
            background: #eff6ff;
            border-left: 4px solid #2563eb;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 0.875rem;
            color: #1e40af;
            line-height: 1.6;
        }
        
        .button-bar {
            display: flex;
            gap: 12px;
            margin: 32px 0;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        
        .btn-calculate {
            background: #2563eb;
            color: white;
            padding: 14px 32px;
            font-size: 1rem;
            font-weight: 600;
            width: 100%;
        }
        
        .btn-calculate:hover {
            background: #1d4ed8;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }
        
        .btn-calculate:active {
            transform: translateY(1px);
        }
        
        .btn-secondary {
            background: white;
            color: #0f172a;
            border: 1px solid #cbd5e1;
        }
        
        .btn-secondary:hover {
            background: #f8fafc;
            border-color: #94a3b8;
        }
        
        .btn-load {
            background: white;
            color: #0f172a;
            border: 1px solid #cbd5e1;
            position: relative;
            overflow: hidden;
        }
        
        .btn-load:hover {
            background: #f8fafc;
            border-color: #94a3b8;
        }
        
        .btn-load input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .results {
            display: none;
        }
        
        .results.show {
            display: block;
        }
        
        .results-highlight {
            background: white;
            padding: 40px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
        }
        
        .dscr-value {
            font-size: 3rem;
            text-align: center;
            margin: 20px 0;
            color: #0f172a;
            font-weight: 700;
        }
        
        .dscr-status {
            text-align: center;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            margin: 16px 0;
            font-size: 1rem;
        }
        
        .status-excellent {
            background: #dcfce7;
            color: #15803d;
            border: 1px solid #86efac;
        }
        
        .status-good {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        .status-fair {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde047;
        }
        
        .status-poor {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .result-row:last-child {
            border-bottom: none;
        }
        
        .result-label {
            color: #64748b;
            font-weight: 500;
            font-size: 0.9375rem;
        }
        
        .result-value {
            color: #0f172a;
            font-weight: 600;
            font-size: 0.9375rem;
        }
        
        .hidden {
            display: none;
        }
        
        .property-address-display {
            text-align: center;
            color: #64748b;
            font-size: 1rem;
            margin-bottom: 16px;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }
            
            .input-grid {
                grid-template-columns: 1fr;
            }
            
            .button-bar {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .dscr-value {
                font-size: 2rem;
            }
        }
        
        @media print {
            body {
                background: white;
            }
            
            .section {
                box-shadow: none;
                page-break-inside: avoid;
            }
            
            button, .button-bar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DSCR Calculator</h1>
            <p class="subtitle">Calculate Debt Service Coverage Ratio for commercial and investment properties</p>
        </div>

        <div class="button-bar">
            <button class="btn-load">
                📂 Load Saved Calculation
                <input type="file" id="load-file" accept=".json">
            </button>
        </div>

        <form id="dscr-form">
            <!-- Property Information Section -->
            <div class="section">
                <h2 class="section-title">Property Information</h2>
                <div class="input-grid">
                    <div class="form-group">
                        <label for="property-address">Property Address (Optional)</label>
                        <input type="text" id="property-address" placeholder="123 Main St, City, State">
                        <div class="help-text">For your reference and records</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="total-units">Total Units</label>
                        <input type="number" id="total-units" min="1" required>
                        <div class="help-text">Total number of rental units</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="vacant-units">Vacant Units</label>
                        <input type="number" id="vacant-units" min="0" value="0" required>
                        <div class="help-text">Currently vacant units</div>
                    </div>
                </div>
            </div>

            <!-- Income Section -->
            <div class="section">
                <h2 class="section-title">Annual Income</h2>
                <div class="input-grid">
                    <div class="form-group">
                        <label for="occupied-income">Annual Income from Occupied Units</label>
                        <input type="number" id="occupied-income" step="0.01" min="0" required>
                        <div class="help-text">Total rent collected per year from rented units</div>
                    </div>
                    
                    <div class="form-group hidden" id="vacant-income-group">
                        <label for="vacant-income">Potential Annual Income from Vacant Units</label>
                        <input type="number" id="vacant-income" step="0.01" min="0" value="0">
                        <div class="help-text">Expected annual rent for vacant units</div>
                    </div>
                </div>
                
                <div class="calculated-field">
                    <span class="calculated-label">Effective Gross Income (Annual)</span>
                    <span class="calculated-value" id="egi-display">$0</span>
                </div>
                
                <div class="info-box">
                    <strong>Note:</strong> Vacant units are calculated at 75% of stated rent to account for vacancy risk per most lender guidelines.
                </div>
            </div>

            <!-- Expenses Section -->
            <div class="section">
                <h2 class="section-title">Annual Expenses</h2>
                <div class="input-grid">
                    <div class="form-group">
                        <label for="property-tax">Property Taxes (Annual)</label>
                        <input type="number" id="property-tax" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="insurance">Property Insurance (Annual)</label>
                        <input type="number" id="insurance" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="utilities">Utilities (Annual)</label>
                        <input type="number" id="utilities" step="0.01" min="0" value="0">
                        <div class="help-text">If paid by landlord</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="maintenance">Maintenance & Repairs (Annual)</label>
                        <input type="number" id="maintenance" step="0.01" min="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="other-expenses">Other Expenses (Annual)</label>
                        <input type="number" id="other-expenses" step="0.01" min="0" value="0">
                        <div class="help-text">HOA, legal, accounting, etc.</div>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 24px;">
                    <label>Property Management Fee?</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="mgmt-yes" name="management" value="yes">
                            <label for="mgmt-yes">Yes</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="mgmt-no" name="management" value="no" checked>
                            <label for="mgmt-no">No</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group hidden" id="mgmt-fee-group">
                    <label for="mgmt-fee">Annual Management Fee</label>
                    <input type="number" id="mgmt-fee" step="0.01" min="0" value="0">
                    <div class="help-text">Management fee amount from appraisal report</div>
                </div>
                
                <div class="calculated-field">
                    <span class="calculated-label">Net Operating Income (Annual)</span>
                    <span class="calculated-value" id="noi-display">$0</span>
                </div>
            </div>

            <!-- Loan Information Section -->
            <div class="section">
                <h2 class="section-title">Loan Information</h2>
                <div class="input-grid">
                    <div class="form-group">
                        <label for="purchase-price">Purchase Price</label>
                        <input type="number" id="purchase-price" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="down-payment">Down Payment (%)</label>
                        <input type="number" id="down-payment" step="0.01" min="0" max="100" value="20" required>
                        <div class="help-text">Typical: 20-25% for investment properties</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="interest-rate">Interest Rate (%)</label>
                        <input type="number" id="interest-rate" step="0.01" min="0" required>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 24px;">
                    <label>Payment Type</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="payment-amortizing" name="payment-type" value="amortizing" checked>
                            <label for="payment-amortizing">Amortizing</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="payment-interest" name="payment-type" value="interest">
                            <label for="payment-interest">Interest Only</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" id="loan-term-group">
                    <label for="loan-term">Loan Term (Years)</label>
                    <input type="number" id="loan-term" min="1" max="40" value="30" required>
                    <div class="help-text">Length of the loan period (common: 15, 20, 30, or 40 years)</div>
                </div>
                
                <div class="calculated-field">
                    <span class="calculated-label">Loan Amount</span>
                    <span class="calculated-value" id="loan-amount-display">$0</span>
                </div>
            </div>

            <!-- Calculate Button -->
            <button type="submit" class="btn-calculate">Calculate DSCR</button>
        </form>

        <!-- Results Section -->
        <div id="results" class="results">
            <div class="results-highlight">
                <div class="property-address-display" id="result-property-address"></div>
                <div class="dscr-value" id="dscr-value">0.00</div>
                <div class="dscr-status" id="dscr-status"></div>
            </div>

            <div class="section">
                <h2 class="section-title">Property Details</h2>
                <div class="result-row">
                    <span class="result-label">Purchase Price:</span>
                    <span class="result-value" id="result-purchase-price">$0</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Down Payment:</span>
                    <span class="result-value" id="result-down-payment">$0</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Loan Amount:</span>
                    <span class="result-value" id="result-loan-amount">$0</span>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Income Analysis</h2>
                <div class="result-row">
                    <span class="result-label">Occupied Unit Income (Annual):</span>
                    <span class="result-value" id="result-occupied">$0</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Vacant Unit Income (75% Annual):</span>
                    <span class="result-value" id="result-vacant">$0</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Effective Gross Income:</span>
                    <span class="result-value" id="result-egi">$0</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Total Operating Expenses:</span>
                    <span class="result-value" id="result-expenses">$0</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Net Operating Income (NOI):</span>
                    <span class="result-value" id="result-noi">$0</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Additional Adjustment:</span>
                    <span class="result-value" id="result-adjustment">$0</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Qualifying Income:</span>
                    <span class="result-value" id="result-income">$0</span>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Debt Service</h2>
                <div class="result-row">
                    <span class="result-label">Payment Type:</span>
                    <span class="result-value" id="result-payment-type">-</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Annual Debt Service:</span>
                    <span class="result-value" id="result-debt">$0</span>
                </div>
            </div>

            <div class="info-box">
                <strong>Understanding DSCR:</strong><br><br>
                • <strong>1.25+</strong> = Excellent (Most lenders prefer this)<br>
                • <strong>1.15-1.24</strong> = Good (Many lenders accept)<br>
                • <strong>1.00-1.14</strong> = Fair (Limited lender options)<br>
                • <strong>Below 1.00</strong> = Poor (Property doesn't cover debt)<br><br>
                <strong>Formula:</strong> DSCR = Qualifying Income ÷ Annual Debt Service
            </div>

            <div class="button-bar">
                <button type="button" class="btn-secondary" onclick="emailResults()">📧 Email Results</button>
                <button type="button" class="btn-secondary" onclick="printResults()">🖨️ Print</button>
                <button type="button" class="btn-secondary" onclick="saveResults()">💾 Save</button>
                <button type="button" class="btn-secondary" onclick="resetForm()">🔄 Reset</button>
            </div>
        </div>
    </div>

    <script>
        // Get form elements
        const form = document.getElementById('dscr-form');
        const results = document.getElementById('results');
        
        // Property inputs
        const propertyAddressInput = document.getElementById('property-address');
        const totalUnitsInput = document.getElementById('total-units');
        const vacantUnitsInput = document.getElementById('vacant-units');
        const vacantIncomeGroup = document.getElementById('vacant-income-group');
        
        // Income inputs
        const occupiedIncomeInput = document.getElementById('occupied-income');
        const vacantIncomeInput = document.getElementById('vacant-income');
        const egiDisplay = document.getElementById('egi-display');
        
        // Expense inputs
        const propertyTaxInput = document.getElementById('property-tax');
        const insuranceInput = document.getElementById('insurance');
        const utilitiesInput = document.getElementById('utilities');
        const maintenanceInput = document.getElementById('maintenance');
        const otherExpensesInput = document.getElementById('other-expenses');
        const mgmtYes = document.getElementById('mgmt-yes');
        const mgmtNo = document.getElementById('mgmt-no');
        const mgmtFeeGroup = document.getElementById('mgmt-fee-group');
        const mgmtFeeInput = document.getElementById('mgmt-fee');
        const noiDisplay = document.getElementById('noi-display');
        
        // Loan inputs
        const purchasePriceInput = document.getElementById('purchase-price');
        const downPaymentInput = document.getElementById('down-payment');
        const interestRateInput = document.getElementById('interest-rate');
        const paymentAmortizing = document.getElementById('payment-amortizing');
        const paymentInterest = document.getElementById('payment-interest');
        const loanTermGroup = document.getElementById('loan-term-group');
        const loanTermInput = document.getElementById('loan-term');
        const loanAmountDisplay = document.getElementById('loan-amount-display');

        // Show/hide vacant income field based on vacant units
        vacantUnitsInput.addEventListener('input', function() {
            const vacantUnits = parseInt(this.value) || 0;
            if (vacantUnits > 0) {
                vacantIncomeGroup.classList.remove('hidden');
                vacantIncomeInput.required = true;
            } else {
                vacantIncomeGroup.classList.add('hidden');
                vacantIncomeInput.required = false;
                vacantIncomeInput.value = '0';
            }
            updateRealTimeCalculations();
        });

        // Show/hide management fee field
        mgmtYes.addEventListener('change', function() {
            if (this.checked) {
                mgmtFeeGroup.classList.remove('hidden');
            }
            updateRealTimeCalculations();
        });

        mgmtNo.addEventListener('change', function() {
            if (this.checked) {
                mgmtFeeGroup.classList.add('hidden');
            }
            updateRealTimeCalculations();
        });

        // Show/hide loan term based on payment type - actually keep it visible for both
        paymentAmortizing.addEventListener('change', function() {
            if (this.checked) {
                loanTermInput.required = true;
            }
        });

        paymentInterest.addEventListener('change', function() {
            if (this.checked) {
                loanTermInput.required = true; // Still required for interest-only to know the period
            }
        });

        // Real-time calculation updates
        function updateRealTimeCalculations() {
            updateEGI();
            updateNOI();
        }

        function updateEGI() {
            const occupiedIncome = parseFloat(occupiedIncomeInput.value) || 0;
            const vacantIncome = parseFloat(vacantIncomeInput.value) || 0;
            const vacantUnits = parseInt(vacantUnitsInput.value) || 0;
            
            // Income is already annual, no need to multiply by 12
            const annualOccupied = occupiedIncome;
            
            // Annual vacant income at 75%
            const annualVacant = vacantUnits > 0 ? (vacantIncome * 0.75) : 0;
            
            const egi = annualOccupied + annualVacant;
            egiDisplay.textContent = formatCurrency(egi);
        }

        function updateNOI() {
            const occupiedIncome = parseFloat(occupiedIncomeInput.value) || 0;
            const vacantIncome = parseFloat(vacantIncomeInput.value) || 0;
            const vacantUnits = parseInt(vacantUnitsInput.value) || 0;
            
            const annualOccupied = occupiedIncome;
            const annualVacant = vacantUnits > 0 ? (vacantIncome * 0.75) : 0;
            const egi = annualOccupied + annualVacant;
            
            const propertyTax = parseFloat(propertyTaxInput.value) || 0;
            const insurance = parseFloat(insuranceInput.value) || 0;
            const utilities = parseFloat(utilitiesInput.value) || 0;
            const maintenance = parseFloat(maintenanceInput.value) || 0;
            const otherExpenses = parseFloat(otherExpensesInput.value) || 0;
            
            // Management fee is a flat dollar amount, not a percentage
            let mgmtFee = 0;
            if (mgmtYes.checked) {
                mgmtFee = parseFloat(mgmtFeeInput.value) || 0;
            }
            
            const totalExpenses = propertyTax + insurance + utilities + maintenance + otherExpenses + mgmtFee;
            const noi = egi - totalExpenses;
            
            noiDisplay.textContent = formatCurrency(noi);
        }

        function updateLoanAmountDisplay() {
            const purchasePrice = parseFloat(purchasePriceInput.value) || 0;
            const downPaymentPct = parseFloat(downPaymentInput.value) || 0;
            const downPaymentAmount = purchasePrice * (downPaymentPct / 100);
            const loanAmount = purchasePrice - downPaymentAmount;
            loanAmountDisplay.textContent = formatCurrency(loanAmount);
        }

        // Add event listeners for real-time updates
        [occupiedIncomeInput, vacantIncomeInput, propertyTaxInput, insuranceInput, 
         utilitiesInput, maintenanceInput, otherExpensesInput, mgmtFeeInput].forEach(input => {
            input.addEventListener('input', updateRealTimeCalculations);
        });

        [purchasePriceInput, downPaymentInput].forEach(input => {
            input.addEventListener('input', updateLoanAmountDisplay);
        });

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Calculate DSCR
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get all input values
            const totalUnits = parseInt(totalUnitsInput.value);
            const vacantUnits = parseInt(vacantUnitsInput.value) || 0;
            const occupiedIncome = parseFloat(occupiedIncomeInput.value);
            const vacantIncome = parseFloat(vacantIncomeInput.value) || 0;
            const propertyTax = parseFloat(propertyTaxInput.value);
            const insurance = parseFloat(insuranceInput.value);
            const utilities = parseFloat(utilitiesInput.value) || 0;
            const maintenance = parseFloat(maintenanceInput.value) || 0;
            const otherExpenses = parseFloat(otherExpensesInput.value) || 0;
            const purchasePrice = parseFloat(purchasePriceInput.value);
            const downPaymentPct = parseFloat(downPaymentInput.value);
            const interestRate = parseFloat(interestRateInput.value) / 100;
            const loanTerm = parseInt(loanTermInput.value) || 30; // Default to 30 if not specified
            const isAmortizing = paymentAmortizing.checked;
            
            // Validate required fields
            if (!totalUnits || !occupiedIncome || !propertyTax || !insurance || !purchasePrice || !downPaymentPct || !interestRate) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // For amortizing loans, ensure loan term is provided
            if (isAmortizing && !loanTerm) {
                alert('Please enter a loan term for amortizing loans.');
                return;
            }
            
            // Calculate loan details
            const downPaymentAmount = purchasePrice * (downPaymentPct / 100);
            const loanAmount = purchasePrice - downPaymentAmount;
            
            // Calculate income - inputs are already annual
            const annualOccupied = occupiedIncome;
            const annualVacant = vacantUnits > 0 ? (vacantIncome * 0.75) : 0;
            const egi = annualOccupied + annualVacant;
            
            // Calculate expenses - management fee is flat dollar amount
            let mgmtFee = 0;
            if (mgmtYes.checked) {
                mgmtFee = parseFloat(mgmtFeeInput.value) || 0;
            }
            
            const totalExpenses = propertyTax + insurance + utilities + maintenance + otherExpenses + mgmtFee;
            const noi = egi - totalExpenses;
            
            // Additional adjustment (typically 25% reserves for 2-4 units, or actual HOA fees if more)
            let adjustment = 0;
            if (totalUnits >= 2 && totalUnits <= 4) {
                adjustment = noi * 0.25;
            }
            
            const qualifyingIncome = noi - adjustment;
            
            // Calculate debt service
            let annualDebtService;
            if (isAmortizing) {
                const monthlyRate = interestRate / 12;
                const numPayments = loanTerm * 12;
                const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                                     (Math.pow(1 + monthlyRate, numPayments) - 1);
                annualDebtService = monthlyPayment * 12;
            } else {
                annualDebtService = loanAmount * interestRate;
            }
            
            // Calculate DSCR
            const dscr = qualifyingIncome / annualDebtService;
            
            // Display results
            const propertyAddress = propertyAddressInput.value || 'Property Address Not Specified';
            document.getElementById('result-property-address').textContent = propertyAddress;
            document.getElementById('result-purchase-price').textContent = formatCurrency(purchasePrice);
            document.getElementById('result-down-payment').textContent = formatCurrency(downPaymentAmount) + ' (' + downPaymentPct + '%)';
            document.getElementById('result-loan-amount').textContent = formatCurrency(loanAmount);
            document.getElementById('result-occupied').textContent = formatCurrency(annualOccupied);
            document.getElementById('result-vacant').textContent = formatCurrency(annualVacant);
            document.getElementById('result-egi').textContent = formatCurrency(egi);
            document.getElementById('result-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('result-noi').textContent = formatCurrency(noi);
            document.getElementById('result-adjustment').textContent = formatCurrency(adjustment);
            document.getElementById('result-income').textContent = formatCurrency(qualifyingIncome);
            document.getElementById('result-payment-type').textContent = isAmortizing ? 'Amortizing' : 'Interest Only';
            document.getElementById('result-debt').textContent = formatCurrency(annualDebtService);
            document.getElementById('dscr-value').textContent = dscr.toFixed(2);
            
            // Set status
            const statusElement = document.getElementById('dscr-status');
            statusElement.className = 'dscr-status';
            
            if (dscr >= 1.25) {
                statusElement.classList.add('status-excellent');
                statusElement.textContent = '✓ Excellent - Strong Cash Flow';
            } else if (dscr >= 1.15) {
                statusElement.classList.add('status-good');
                statusElement.textContent = '✓ Good - Acceptable Cash Flow';
            } else if (dscr >= 1.00) {
                statusElement.classList.add('status-fair');
                statusElement.textContent = '⚠ Fair - Marginal Cash Flow';
            } else {
                statusElement.classList.add('status-poor');
                statusElement.textContent = '✗ Poor - Negative Cash Flow';
            }
            
            // Show results
            results.classList.add('show');
            results.scrollIntoView({ behavior: 'smooth' });
        });

        // Email Results
        function emailResults() {
            const propertyAddress = propertyAddressInput.value || 'Property Address Not Specified';
            const dscr = document.getElementById('dscr-value').textContent;
            const status = document.getElementById('dscr-status').textContent;
            const purchasePrice = parseFloat(purchasePriceInput.value);
            const downPaymentPct = parseFloat(downPaymentInput.value);
            const downPaymentAmount = purchasePrice * (downPaymentPct / 100);
            const loanAmount = purchasePrice - downPaymentAmount;
            const interestRate = parseFloat(interestRateInput.value);
            const paymentTypeDisplay = paymentAmortizing.checked ? 'Amortizing' : 'Interest Only';
            const loanTerm = parseInt(loanTermInput.value);
            const totalUnits = parseInt(totalUnitsInput.value);
            const vacantUnits = parseInt(vacantUnitsInput.value) || 0;
            
            const occupiedIncome = parseFloat(occupiedIncomeInput.value);
            const vacantIncome = parseFloat(vacantIncomeInput.value) || 0;
            const annualOccupied = occupiedIncome;
            const annualVacant = vacantUnits > 0 ? (vacantIncome * 0.75) : 0;
            const egi = annualOccupied + annualVacant;
            
            const subject = encodeURIComponent(`DSCR Calculation - ${propertyAddress}`);
            
            const addressLine = propertyAddress ? `Property Address: ${propertyAddress}\n` : '';
            
            const body = encodeURIComponent(
                `DSCR CALCULATION REPORT\n` +
                `═══════════════════════════════════════════════\n` +
                `PROPERTY INFORMATION\n` +
                `═══════════════════════════════════════════════\n` +
                `${addressLine}` +
                `Total Units: ${totalUnits}\n` +
                `Vacant Units: ${vacantUnits}\n\n` +
                `═══════════════════════════════════════════════\n` +
                `FINANCIAL OVERVIEW\n` +
                `═══════════════════════════════════════════════\n` +
                `Purchase Price: ${formatCurrency(purchasePrice)}\n` +
                `Down Payment: ${formatCurrency(downPaymentAmount)} (${downPaymentPct}%)\n` +
                `Loan Amount: ${formatCurrency(loanAmount)}\n` +
                `Interest Rate: ${interestRate}%\n` +
                `Payment Type: ${paymentTypeDisplay}\n` +
                (paymentTypeDisplay === 'Amortizing' ? `Loan Term: ${loanTerm} years\n` : '') +
                `\n═══════════════════════════════════════════════\n` +
                `INCOME ANALYSIS\n` +
                `═══════════════════════════════════════════════\n` +
                `Occupied Unit Income: ${formatCurrency(annualOccupied)}\n` +
                `Vacant Unit Income (75%): ${formatCurrency(annualVacant)}\n` +
                `Effective Gross Income: ${formatCurrency(egi)}\n\n` +
                `═══════════════════════════════════════════════\n` +
                `EXPENSES\n` +
                `═══════════════════════════════════════════════\n` +
                `Property Taxes: ${formatCurrency(parseFloat(propertyTaxInput.value))}\n` +
                `Insurance: ${formatCurrency(parseFloat(insuranceInput.value))}\n` +
                `Utilities: ${formatCurrency(parseFloat(utilitiesInput.value) || 0)}\n` +
                `Maintenance: ${formatCurrency(parseFloat(maintenanceInput.value) || 0)}\n` +
                `Other Expenses: ${formatCurrency(parseFloat(otherExpensesInput.value) || 0)}\n` +
                `Total Operating Expenses: ${document.getElementById('result-expenses').textContent}\n\n` +
                `═══════════════════════════════════════════════\n` +
                `DSCR CALCULATION\n` +
                `═══════════════════════════════════════════════\n` +
                `Net Operating Income (NOI): ${document.getElementById('result-noi').textContent}\n` +
                `Additional Adjustment: ${document.getElementById('result-adjustment').textContent}\n` +
                `Qualifying Income: ${document.getElementById('result-income').textContent}\n` +
                `Annual Debt Service: ${document.getElementById('result-debt').textContent}\n\n` +
                `DSCR: ${dscr}\n` +
                `Status: ${status}\n\n` +
                `═══════════════════════════════════════════════\n` +
                `NOTES\n` +
                `═══════════════════════════════════════════════\n` +
                `Most lenders require a minimum DSCR of 1.20-1.25\n` +
                `Formula: DSCR = Qualifying Income ÷ Annual Debt Service\n\n` +
                `This calculation is for informational purposes only and does not constitute a loan commitment.`
            );

            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        // Print Results
        function printResults() {
            window.print();
        }

        // Save Results
        function saveResults() {
            const data = {
                timestamp: new Date().toISOString(),
                inputs: {
                    propertyAddress: propertyAddressInput.value,
                    totalUnits: totalUnitsInput.value,
                    vacantUnits: vacantUnitsInput.value,
                    occupiedIncome: occupiedIncomeInput.value,
                    vacantIncome: vacantIncomeInput.value,
                    propertyTax: propertyTaxInput.value,
                    insurance: insuranceInput.value,
                    utilities: utilitiesInput.value,
                    maintenance: maintenanceInput.value,
                    otherExpenses: otherExpensesInput.value,
                    hasMgmtFee: document.querySelector('input[name="management"]:checked')?.value,
                    mgmtFee: mgmtFeeInput.value,
                    purchasePrice: purchasePriceInput.value,
                    downPayment: downPaymentInput.value,
                    interestRate: interestRateInput.value,
                    paymentType: document.querySelector('input[name="payment-type"]:checked')?.value,
                    loanTerm: loanTermInput.value
                },
                results: {
                    propertyAddress: propertyAddressInput.value || 'Not specified',
                    purchasePrice: document.getElementById('result-purchase-price').textContent,
                    downPayment: document.getElementById('result-down-payment').textContent,
                    loanAmount: document.getElementById('result-loan-amount').textContent,
                    occupiedIncome: document.getElementById('result-occupied').textContent,
                    vacantIncome: document.getElementById('result-vacant').textContent,
                    egi: document.getElementById('result-egi').textContent,
                    expenses: document.getElementById('result-expenses').textContent,
                    noi: document.getElementById('result-noi').textContent,
                    adjustment: document.getElementById('result-adjustment').textContent,
                    qualifyingIncome: document.getElementById('result-income').textContent,
                    paymentType: document.getElementById('result-payment-type').textContent,
                    annualDebt: document.getElementById('result-debt').textContent,
                    dscr: document.getElementById('dscr-value').textContent,
                    status: document.getElementById('dscr-status').textContent
                }
            };

            // Create filename with address
            const address = propertyAddressInput.value || 'Property';
            const cleanAddress = address
                .replace(/,/g, '') // Remove commas
                .replace(/[^a-zA-Z0-9\s-]/g, '') // Remove other special characters
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .replace(/-+/g, '-') // Replace multiple hyphens with single hyphen
                .replace(/^-|-$/g, '') // Remove leading/trailing hyphens
                .substring(0, 50); // Limit length
            const date = new Date().toISOString().split('T')[0];
            const filename = `${cleanAddress}-${date}-DSCR-Calculation.json`;

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Reset Form
        function resetForm() {
            form.reset();
            results.classList.remove('show');
            vacantIncomeGroup.classList.add('hidden');
            mgmtFeeGroup.classList.add('hidden');
            egiDisplay.textContent = '$0';
            noiDisplay.textContent = '$0';
            loanAmountDisplay.textContent = '$0';
        }

        // Load File
        document.getElementById('load-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    // Populate all form fields
                    propertyAddressInput.value = data.inputs.propertyAddress || '';
                    totalUnitsInput.value = data.inputs.totalUnits || '';
                    vacantUnitsInput.value = data.inputs.vacantUnits || '0';
                    occupiedIncomeInput.value = data.inputs.occupiedIncome || '';
                    vacantIncomeInput.value = data.inputs.vacantIncome || '0';
                    propertyTaxInput.value = data.inputs.propertyTax || '';
                    insuranceInput.value = data.inputs.insurance || '';
                    utilitiesInput.value = data.inputs.utilities || '0';
                    maintenanceInput.value = data.inputs.maintenance || '0';
                    otherExpensesInput.value = data.inputs.otherExpenses || '0';
                    
                    // Handle both old and new format
                    if (data.inputs.purchasePrice) {
                        purchasePriceInput.value = data.inputs.purchasePrice || '';
                        downPaymentInput.value = data.inputs.downPayment || '20';
                    } else if (data.inputs.loanAmount) {
                        const oldLoanAmount = parseFloat(data.inputs.loanAmount);
                        const estimatedPurchasePrice = oldLoanAmount / 0.8;
                        purchasePriceInput.value = estimatedPurchasePrice.toFixed(2);
                        downPaymentInput.value = '20';
                    }
                    
                    interestRateInput.value = data.inputs.interestRate || '';
                    loanTermInput.value = data.inputs.loanTerm || '';

                    // Set payment type
                    if (data.inputs.paymentType === 'interest') {
                        paymentInterest.checked = true;
                    } else {
                        paymentAmortizing.checked = true;
                    }

                    // Set management fee
                    if (data.inputs.hasMgmtFee === 'yes') {
                        mgmtYes.checked = true;
                        mgmtFeeGroup.classList.remove('hidden');
                        mgmtFeeInput.value = data.inputs.mgmtFee || '';
                    } else {
                        mgmtNo.checked = true;
                        mgmtFeeGroup.classList.add('hidden');
                    }

                    // Trigger updates
                    vacantUnitsInput.dispatchEvent(new Event('input'));
                    updateLoanAmountDisplay();
                    updateRealTimeCalculations();

                    form.scrollIntoView({ behavior: 'smooth' });
                    alert('Calculation loaded successfully! Review the values and click "Calculate DSCR" to see results.');
                    
                } catch (error) {
                    alert('Error loading file. Please make sure it is a valid DSCR calculation file.');
                    console.error('Load error:', error);
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });
    </script>
</body>
</html>
