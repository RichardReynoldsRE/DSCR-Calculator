<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commercial Property DSCR Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #718096;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .section-header {
            color: #2d3748;
            font-size: 18px;
            font-weight: 600;
            margin-top: 25px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }

        .section-header:first-of-type {
            margin-top: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .help-text {
            font-size: 12px;
            color: #718096;
            font-weight: 400;
            margin-top: 4px;
        }

        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .calculated-field {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calculated-label {
            color: #4a5568;
            font-weight: 600;
        }

        .calculated-value {
            color: #2d3748;
            font-size: 18px;
            font-weight: 700;
        }

        .info-box {
            background: #ebf8ff;
            border-left: 4px solid #4299e1;
            padding: 12px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 13px;
            color: #2c5282;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .results {
            margin-top: 30px;
            padding: 25px;
            background: #f7fafc;
            border-radius: 12px;
            display: none;
        }

        .results.show {
            display: block;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-label {
            color: #4a5568;
            font-weight: 500;
        }

        .result-value {
            color: #2d3748;
            font-weight: 600;
        }

        .dscr-value {
            font-size: 32px;
            text-align: center;
            margin: 20px 0;
            color: #2d3748;
        }

        .dscr-status {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 15px;
        }

        .dscr-status.good {
            background: #c6f6d5;
            color: #22543d;
        }

        .dscr-status.warning {
            background: #feebc8;
            color: #7c2d12;
        }

        .dscr-status.poor {
            background: #fed7d7;
            color: #742a2a;
        }

        .note {
            background: #edf2f7;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 13px;
            color: #4a5568;
            line-height: 1.6;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 10px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #667eea;
            color: white;
        }

        .load-section {
            margin-top: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            text-align: center;
        }

        .load-section input[type="file"] {
            display: none;
        }

        .load-label {
            display: inline-block;
            padding: 10px 20px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .load-label:hover {
            background: #667eea;
            color: white;
        }

        .hidden {
            display: none;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                max-width: 100%;
                padding: 20px;
            }

            form, .note, .action-buttons, .load-section {
                display: none !important;
            }

            .results {
                display: block !important;
                page-break-inside: avoid;
            }

            .section-header {
                page-break-after: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>DSCR Calculator</h1>
        <p class="subtitle">Debt Service Coverage Ratio for 5-8 unit properties</p>

        <div class="load-section">
            <p style="margin-bottom: 10px; color: #4a5568; font-weight: 600;">Load Previous Calculation</p>
            <input type="file" id="load-file" accept=".json">
            <label for="load-file" class="load-label">Choose File to Load</label>
        </div>

        <form id="dscr-form">
            <div class="section-header">Property Overview</div>
            
            <div class="form-group">
                <label for="total-units">
                    Total Number of Units *
                    <div class="help-text">Total units in the property (5-8)</div>
                </label>
                <input type="number" id="total-units" required min="1" max="100" step="1" placeholder="e.g., 8">
            </div>

            <div class="form-group">
                <label for="vacant-units">
                    Number of Vacant Units *
                    <div class="help-text">How many units are currently empty</div>
                </label>
                <input type="number" id="vacant-units" required min="0" step="1" value="0" placeholder="e.g., 0">
            </div>

            <div class="section-header">Property Income</div>
            
            <div class="form-group">
                <label for="occupied-income">
                    Annual Income from Occupied Units *
                    <div class="help-text">Total rent collected per year from rented units</div>
                </label>
                <input type="number" id="occupied-income" required min="0" step="0.01" placeholder="e.g., 96000">
            </div>

            <div class="form-group" id="vacant-income-group">
                <label for="vacant-income">
                    Potential Annual Income from Vacant Units *
                    <div class="help-text">What vacant units could generate if rented at market rate</div>
                </label>
                <input type="number" id="vacant-income" min="0" step="0.01" value="0" placeholder="e.g., 24000">
                <div class="info-box">
                    Lenders typically apply a 75% factor to vacant unit income to account for risk.
                </div>
            </div>

            <div class="section-header">Property Expenses</div>

            <div class="form-group">
                <label for="property-tax">
                    Annual Property Taxes *
                    <div class="help-text">Yearly property tax bill</div>
                </label>
                <input type="number" id="property-tax" required min="0" step="0.01" placeholder="e.g., 8000">
            </div>

            <div class="form-group">
                <label for="insurance">
                    Annual Insurance *
                    <div class="help-text">Property and liability insurance costs per year</div>
                </label>
                <input type="number" id="insurance" required min="0" step="0.01" placeholder="e.g., 3000">
            </div>

            <div class="form-group">
                <label for="utilities">
                    Annual Utilities
                    <div class="help-text">Water, electric, gas paid by owner (if any)</div>
                </label>
                <input type="number" id="utilities" min="0" step="0.01" value="0" placeholder="e.g., 2400">
            </div>

            <div class="form-group">
                <label for="maintenance">
                    Annual Maintenance & Repairs
                    <div class="help-text">Routine maintenance, repairs, landscaping, etc.</div>
                </label>
                <input type="number" id="maintenance" min="0" step="0.01" value="0" placeholder="e.g., 5000">
            </div>

            <div class="form-group">
                <label for="other-expenses">
                    Other Annual Operating Expenses
                    <div class="help-text">HOA fees, pest control, advertising, etc.</div>
                </label>
                <input type="number" id="other-expenses" min="0" step="0.01" value="0" placeholder="e.g., 1500">
            </div>

            <div class="calculated-field">
                <span class="calculated-label">Effective Gross Income:</span>
                <span class="calculated-value" id="egi-display">$0</span>
            </div>

            <div class="calculated-field">
                <span class="calculated-label">Net Operating Income (NOI):</span>
                <span class="calculated-value" id="noi-display">$0</span>
            </div>

            <div class="section-header">Adjustments</div>

            <div class="form-group">
                <label>Does the appraisal report include a management fee? *</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="mgmt-yes" name="management" value="yes" required>
                        <label for="mgmt-yes" style="margin: 0;">Yes</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="mgmt-no" name="management" value="no">
                        <label for="mgmt-no" style="margin: 0;">No</label>
                    </div>
                </div>
            </div>

            <div class="form-group hidden" id="mgmt-fee-group">
                <label for="mgmt-fee">
                    Annual Management Fee
                    <div class="help-text">Management fee amount from appraisal report</div>
                </label>
                <input type="number" id="mgmt-fee" min="0" step="0.01" placeholder="e.g., 6000">
            </div>

            <div class="section-header">Loan Details</div>

            <div class="form-group">
                <label for="loan-amount">
                    Loan Amount *
                    <div class="help-text">Total amount you're borrowing</div>
                </label>
                <input type="number" id="loan-amount" required min="0" step="0.01" placeholder="e.g., 800000">
            </div>

            <div class="form-group">
                <label for="interest-rate">
                    Interest Rate (%) *
                    <div class="help-text">Annual interest rate for the loan</div>
                </label>
                <input type="number" id="interest-rate" required min="0" max="100" step="0.01" placeholder="e.g., 7.5">
            </div>

            <div class="form-group">
                <label>Payment Type *</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="payment-amortizing" name="payment-type" value="amortizing" required checked>
                        <label for="payment-amortizing" style="margin: 0;">Amortizing (Principal + Interest)</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="payment-interest" name="payment-type" value="interest">
                        <label for="payment-interest" style="margin: 0;">Interest Only</label>
                    </div>
                </div>
            </div>

            <div class="form-group" id="loan-term-group">
                <label for="loan-term">
                    Loan Term (Years) *
                    <div class="help-text">Number of years to repay the loan</div>
                </label>
                <input type="number" id="loan-term" required min="1" max="50" step="1" placeholder="e.g., 30">
            </div>

            <button type="submit">Calculate DSCR</button>
        </form>

        <div class="results" id="results">
            <div class="result-row">
                <span class="result-label">Occupied Unit Income:</span>
                <span class="result-value" id="result-occupied">$0</span>
            </div>
            <div class="result-row">
                <span class="result-label">Vacant Unit Income (75%):</span>
                <span class="result-value" id="result-vacant">$0</span>
            </div>
            <div class="result-row">
                <span class="result-label">Effective Gross Income:</span>
                <span class="result-value" id="result-egi">$0</span>
            </div>
            <div class="result-row">
                <span class="result-label">Total Operating Expenses:</span>
                <span class="result-value" id="result-expenses">$0</span>
            </div>
            <div class="result-row">
                <span class="result-label">Net Operating Income:</span>
                <span class="result-value" id="result-noi">$0</span>
            </div>
            <div class="result-row">
                <span class="result-label">Additional Adjustment:</span>
                <span class="result-value" id="result-adjustment">-</span>
            </div>
            <div class="result-row">
                <span class="result-label">Qualifying Income:</span>
                <span class="result-value" id="result-income">$0</span>
            </div>
            <div class="result-row">
                <span class="result-label">Payment Type:</span>
                <span class="result-value" id="result-payment-type">-</span>
            </div>
            <div class="result-row">
                <span class="result-label">Annual Debt Service:</span>
                <span class="result-value" id="result-debt">$0</span>
            </div>
            
            <div class="dscr-value" id="dscr-value">0.00</div>
            <div class="dscr-status" id="dscr-status"></div>

            <div class="action-buttons">
                <button type="button" class="action-btn" onclick="emailResults()">üìß Email Results</button>
                <button type="button" class="action-btn" onclick="printResults()">üñ®Ô∏è Print Results</button>
                <button type="button" class="action-btn" onclick="saveResults()">üíæ Save Calculation</button>
                <button type="button" class="action-btn" onclick="document.getElementById('dscr-form').reset(); results.classList.remove('show');">üîÑ New Calculation</button>
            </div>
        </div>

        <div class="note">
            <strong>Understanding DSCR:</strong><br>
            DSCR (Debt Service Coverage Ratio) measures if your property generates enough income to cover loan payments. Most lenders require a minimum DSCR of 1.20-1.25.<br><br>
            <strong>How qualifying income is calculated:</strong><br>
            ‚Ä¢ Occupied units: 100% of actual rental income<br>
            ‚Ä¢ Vacant units: 75% of potential rental income<br>
            ‚Ä¢ With management fee: Subtract management fee from NOI<br>
            ‚Ä¢ No management fee: Multiply NOI by 92%<br><br>
            <strong>Payment Types:</strong><br>
            ‚Ä¢ Amortizing: Regular principal + interest payments over the loan term<br>
            ‚Ä¢ Interest Only: Pay only interest (no principal reduction)<br><br>
            <strong>Formula:</strong> DSCR = Qualifying Income √∑ Annual Debt Service
        </div>
    </div>

    <script>
        const form = document.getElementById('dscr-form');
        const mgmtYes = document.getElementById('mgmt-yes');
        const mgmtNo = document.getElementById('mgmt-no');
        const mgmtFeeGroup = document.getElementById('mgmt-fee-group');
        const vacantUnitsInput = document.getElementById('vacant-units');
        const vacantIncomeGroup = document.getElementById('vacant-income-group');
        const paymentAmortizing = document.getElementById('payment-amortizing');
        const paymentInterest = document.getElementById('payment-interest');
        const loanTermGroup = document.getElementById('loan-term-group');
        const loanTermInput = document.getElementById('loan-term');
        const results = document.getElementById('results');
        const egiDisplay = document.getElementById('egi-display');
        const noiDisplay = document.getElementById('noi-display');

        // Show/hide loan term based on payment type
        paymentAmortizing.addEventListener('change', () => {
            loanTermGroup.classList.remove('hidden');
            loanTermInput.required = true;
        });

        paymentInterest.addEventListener('change', () => {
            loanTermGroup.classList.add('hidden');
            loanTermInput.required = false;
        });

        // Show/hide vacant income field based on vacant units
        vacantUnitsInput.addEventListener('input', () => {
            const vacantUnits = parseInt(vacantUnitsInput.value) || 0;
            if (vacantUnits > 0) {
                vacantIncomeGroup.classList.remove('hidden');
                document.getElementById('vacant-income').required = true;
            } else {
                vacantIncomeGroup.classList.add('hidden');
                document.getElementById('vacant-income').required = false;
                document.getElementById('vacant-income').value = 0;
            }
            updateCalculations();
        });

        // Calculate and display EGI and NOI in real-time
        const allInputs = [
            'occupied-income', 'vacant-income', 'property-tax', 'insurance', 
            'utilities', 'maintenance', 'other-expenses'
        ];

        allInputs.forEach(id => {
            document.getElementById(id).addEventListener('input', updateCalculations);
        });

        function updateCalculations() {
            const occupiedIncome = parseFloat(document.getElementById('occupied-income').value) || 0;
            const vacantIncome = parseFloat(document.getElementById('vacant-income').value) || 0;
            const vacantUnits = parseInt(document.getElementById('vacant-units').value) || 0;
            
            // Apply 75% to vacant unit income
            const adjustedVacantIncome = vacantUnits > 0 ? vacantIncome * 0.75 : 0;
            const egi = occupiedIncome + adjustedVacantIncome;
            
            const propertyTax = parseFloat(document.getElementById('property-tax').value) || 0;
            const insurance = parseFloat(document.getElementById('insurance').value) || 0;
            const utilities = parseFloat(document.getElementById('utilities').value) || 0;
            const maintenance = parseFloat(document.getElementById('maintenance').value) || 0;
            const otherExpenses = parseFloat(document.getElementById('other-expenses').value) || 0;

            const totalExpenses = propertyTax + insurance + utilities + maintenance + otherExpenses;
            const noi = egi - totalExpenses;

            egiDisplay.textContent = `$${egi.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            noiDisplay.textContent = `$${noi.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        // Show/hide management fee input
        mgmtYes.addEventListener('change', () => {
            mgmtFeeGroup.classList.remove('hidden');
        });

        mgmtNo.addEventListener('change', () => {
            mgmtFeeGroup.classList.add('hidden');
            document.getElementById('mgmt-fee').value = '';
        });

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            calculateDSCR();
        });

        function calculateDSCR() {
            // Calculate income
            const occupiedIncome = parseFloat(document.getElementById('occupied-income').value);
            const vacantIncome = parseFloat(document.getElementById('vacant-income').value) || 0;
            const vacantUnits = parseInt(document.getElementById('vacant-units').value) || 0;
            
            // Apply 75% to vacant unit income only
            const adjustedVacantIncome = vacantUnits > 0 ? vacantIncome * 0.75 : 0;
            const egi = occupiedIncome + adjustedVacantIncome;

            // Calculate expenses
            const propertyTax = parseFloat(document.getElementById('property-tax').value);
            const insurance = parseFloat(document.getElementById('insurance').value);
            const utilities = parseFloat(document.getElementById('utilities').value) || 0;
            const maintenance = parseFloat(document.getElementById('maintenance').value) || 0;
            const otherExpenses = parseFloat(document.getElementById('other-expenses').value) || 0;

            const totalExpenses = propertyTax + insurance + utilities + maintenance + otherExpenses;
            const noi = egi - totalExpenses;

            // Get adjustment factors
            const hasMgmtFee = document.querySelector('input[name="management"]:checked').value === 'yes';
            const mgmtFee = hasMgmtFee ? parseFloat(document.getElementById('mgmt-fee').value) || 0 : 0;
            
            // Get loan details
            const loanAmount = parseFloat(document.getElementById('loan-amount').value);
            const interestRate = parseFloat(document.getElementById('interest-rate').value) / 100;
            const paymentType = document.querySelector('input[name="payment-type"]:checked').value;
            const loanTerm = paymentType === 'amortizing' ? parseInt(document.getElementById('loan-term').value) : 0;

            // Calculate qualifying income based on lending criteria
            // Note: The management fee adjustment is applied AFTER the vacant unit adjustment
            let qualifyingIncome;
            let adjustmentText;

            if (hasMgmtFee && mgmtFee > 0) {
                qualifyingIncome = noi - mgmtFee;
                adjustmentText = `Mgmt Fee: -${mgmtFee.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            } else if (vacantUnits === 0) {
                // Only apply 92% if there are no vacant units
                qualifyingIncome = noi * 0.92;
                adjustmentText = 'NOI √ó 92% (No Mgmt Fee)';
            } else {
                // If there are vacant units, the 75% is already applied, no additional adjustment
                qualifyingIncome = noi;
                adjustmentText = 'None (Vacancy Already Adjusted)';
            }

            // Calculate annual debt service based on payment type
            let annualDebtService;
            
            if (paymentType === 'interest') {
                // Interest-only: just the annual interest
                annualDebtService = loanAmount * interestRate;
            } else {
                // Amortizing: calculate monthly payment then multiply by 12
                const monthlyRate = interestRate / 12;
                const numPayments = loanTerm * 12;
                const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
                annualDebtService = monthlyPayment * 12;
            }

            // Calculate DSCR
            const dscr = qualifyingIncome / annualDebtService;

            // Display results
            document.getElementById('result-occupied').textContent = `$${occupiedIncome.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('result-vacant').textContent = `$${adjustedVacantIncome.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('result-egi').textContent = `$${egi.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('result-expenses').textContent = `$${totalExpenses.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('result-noi').textContent = `${noi.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('result-adjustment').textContent = adjustmentText;
            document.getElementById('result-income').textContent = `${qualifyingIncome.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('result-payment-type').textContent = paymentType === 'interest' ? 'Interest Only' : 'Amortizing';
            document.getElementById('result-debt').textContent = `${annualDebtService.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('dscr-value').textContent = dscr.toFixed(2);

            // DSCR status
            const statusEl = document.getElementById('dscr-status');
            if (dscr >= 1.25) {
                statusEl.textContent = 'Excellent - Strong Likelihood of Approval';
                statusEl.className = 'dscr-status good';
            } else if (dscr >= 1.20) {
                statusEl.textContent = 'Good - Meets Typical Minimum Requirements';
                statusEl.className = 'dscr-status good';
            } else if (dscr >= 1.00) {
                statusEl.textContent = 'Fair - May Require Additional Review';
                statusEl.className = 'dscr-status warning';
            } else {
                statusEl.textContent = 'Below Minimum - May Not Qualify';
                statusEl.className = 'dscr-status poor';
            }

            results.classList.add('show');
            results.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Email Results
        function emailResults() {
            const dscr = document.getElementById('dscr-value').textContent;
            const qualifyingIncome = document.getElementById('result-income').textContent;
            const annualDebt = document.getElementById('result-debt').textContent;
            const status = document.getElementById('dscr-status').textContent;

            const subject = encodeURIComponent('DSCR Calculation Results');
            const body = encodeURIComponent(
                `DSCR Calculation Results\n\n` +
                `DSCR: ${dscr}\n` +
                `Status: ${status}\n\n` +
                `Qualifying Income: ${qualifyingIncome}\n` +
                `Annual Debt Service: ${annualDebt}\n\n` +
                `For detailed breakdown, please see the attached calculation.`
            );

            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        // Print Results
        function printResults() {
            window.print();
        }

        // Save Results
        function saveResults() {
            const data = {
                timestamp: new Date().toISOString(),
                inputs: {
                    totalUnits: document.getElementById('total-units').value,
                    vacantUnits: document.getElementById('vacant-units').value,
                    occupiedIncome: document.getElementById('occupied-income').value,
                    vacantIncome: document.getElementById('vacant-income').value,
                    propertyTax: document.getElementById('property-tax').value,
                    insurance: document.getElementById('insurance').value,
                    utilities: document.getElementById('utilities').value,
                    maintenance: document.getElementById('maintenance').value,
                    otherExpenses: document.getElementById('other-expenses').value,
                    hasMgmtFee: document.querySelector('input[name="management"]:checked')?.value,
                    mgmtFee: document.getElementById('mgmt-fee').value,
                    loanAmount: document.getElementById('loan-amount').value,
                    interestRate: document.getElementById('interest-rate').value,
                    paymentType: document.querySelector('input[name="payment-type"]:checked')?.value,
                    loanTerm: document.getElementById('loan-term').value
                },
                results: {
                    occupiedIncome: document.getElementById('result-occupied').textContent,
                    vacantIncome: document.getElementById('result-vacant').textContent,
                    egi: document.getElementById('result-egi').textContent,
                    expenses: document.getElementById('result-expenses').textContent,
                    noi: document.getElementById('result-noi').textContent,
                    adjustment: document.getElementById('result-adjustment').textContent,
                    qualifyingIncome: document.getElementById('result-income').textContent,
                    paymentType: document.getElementById('result-payment-type').textContent,
                    annualDebt: document.getElementById('result-debt').textContent,
                    dscr: document.getElementById('dscr-value').textContent,
                    status: document.getElementById('dscr-status').textContent
                }
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dscr-calculation-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Load Results
        document.getElementById('load-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    // Populate all form fields
                    document.getElementById('total-units').value = data.inputs.totalUnits || '';
                    document.getElementById('vacant-units').value = data.inputs.vacantUnits || '0';
                    document.getElementById('occupied-income').value = data.inputs.occupiedIncome || '';
                    document.getElementById('vacant-income').value = data.inputs.vacantIncome || '0';
                    document.getElementById('property-tax').value = data.inputs.propertyTax || '';
                    document.getElementById('insurance').value = data.inputs.insurance || '';
                    document.getElementById('utilities').value = data.inputs.utilities || '0';
                    document.getElementById('maintenance').value = data.inputs.maintenance || '0';
                    document.getElementById('other-expenses').value = data.inputs.otherExpenses || '0';
                    document.getElementById('loan-amount').value = data.inputs.loanAmount || '';
                    document.getElementById('interest-rate').value = data.inputs.interestRate || '';
                    document.getElementById('loan-term').value = data.inputs.loanTerm || '';

                    // Set payment type radio buttons
                    if (data.inputs.paymentType === 'interest') {
                        document.getElementById('payment-interest').checked = true;
                        loanTermGroup.classList.add('hidden');
                        loanTermInput.required = false;
                    } else {
                        document.getElementById('payment-amortizing').checked = true;
                        loanTermGroup.classList.remove('hidden');
                        loanTermInput.required = true;
                    }

                    // Set management fee radio buttons
                    if (data.inputs.hasMgmtFee === 'yes') {
                        document.getElementById('mgmt-yes').checked = true;
                        mgmtFeeGroup.classList.remove('hidden');
                        document.getElementById('mgmt-fee').value = data.inputs.mgmtFee || '';
                    } else {
                        document.getElementById('mgmt-no').checked = true;
                        mgmtFeeGroup.classList.add('hidden');
                    }

                    // Trigger vacant units change to show/hide vacant income field
                    vacantUnitsInput.dispatchEvent(new Event('input'));
                    
                    // Update calculations
                    updateCalculations();

                    // Scroll to form
                    form.scrollIntoView({ behavior: 'smooth' });

                    alert('Calculation loaded successfully! Review the values and click "Calculate DSCR" to see results.');
                    
                } catch (error) {
                    alert('Error loading file. Please make sure it is a valid DSCR calculation file.');
                    console.error('Load error:', error);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            e.target.value = '';
        });
    </script>
</body>
</html>
